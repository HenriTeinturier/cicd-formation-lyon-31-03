# Exercice : Cr√©ation d'un Workflow R√©utilisable pour les Tests

## üîç Contexte

Vous √™tes responsable de l'automatisation des tests dans votre projet. Actuellement, vous avez beaucoup de code dupliqu√© entre les tests backend et frontend. Votre objectif est de cr√©er un workflow r√©utilisable qui pourra √™tre utilis√© pour les deux parties de votre application (front et back), tout en conservant la flexibilit√© n√©cessaire pour chaque contexte.

> üí° **Code d'origine** : Vous pouvez trouver le code d'origine du projet dans le fichier [cicd.yml](cicd.yml)

## üéØ Objectifs p√©dagogiques

* Comprendre le concept de workflow r√©utilisable dans GitHub Actions
* Ma√Ætriser la syntaxe pour cr√©er et appeler un workflow r√©utilisable
* Utiliser les inputs et les secrets dans un workflow r√©utilisable
* Int√©grer un workflow r√©utilisable dans un workflow principal
* Conserver des fonctionnalit√©s sp√©cifiques comme les matrices

## üìä Structure du workflow r√©utilisable

```yaml
name: Workflow R√©utilisable

on:
  workflow_call:
    inputs:
      # D√©finition des inputs
    secrets:
      # D√©finition des secrets

jobs:
  job-name:
    # Configuration du job
```

## üìù √âtapes de r√©alisation

### 1Ô∏è‚É£ Comprendre les workflows r√©utilisables

Un workflow r√©utilisable est un workflow qui peut √™tre appel√© par d'autres workflows. Il permet de :
* √âviter la duplication de code
* Centraliser la logique commune
* Personnaliser le comportement via des inputs

#### Syntaxe pour cr√©er un workflow r√©utilisable

```yaml
on:
  workflow_call:
    inputs:
      mon-input:
        required: true
        type: string
        description: "Description de l'input"
    secrets:
      mon-secret:
        required: false
        description: "Description du secret"
```

#### Syntaxe pour appeler un workflow r√©utilisable

```yaml
jobs:
  mon-job:
    uses: ./.github/workflows/mon-workflow.yml
    with:
      mon-input: "valeur"
    secrets:
      mon-secret: ${{ secrets.MON_SECRET }}
```

### 2Ô∏è‚É£ Cr√©er le workflow r√©utilisable pour les tests

#### √âtape 1 : Configurer l'√©v√©nement et les inputs

Commencez par cr√©er un fichier `.github/workflows/check-test.yml` et configurez l'√©v√©nement `workflow_call`.

Voici un exemple de syntaxe pour un input :
```yaml
run-lint:
  required: false
  type: boolean
  default: false
  description: "Ex√©cuter la v√©rification du code"
```

Liste non exhaustive des inputs √† consid√©rer :
* `working-directory` : le r√©pertoire de travail (client ou server)
* `run-lint` : pour ex√©cuter la v√©rification du code
* `run-audit` : pour v√©rifier les vuln√©rabilit√©s
* `run-tests` : pour ex√©cuter les tests
* `codecov-upload` : pour uploader les rapports de couverture

#### √âtape 2 : Configurer les secrets

Vous aurez besoin d'un secret pour Codecov :
```yaml
secrets:
  codecov-token:
    required: false
    description: "Token Codecov pour l'upload des rapports"
```

#### √âtape 3 : Configurer les jobs

Cr√©ez un job qui effectuera les v√©rifications et les tests. Voici quelques points importants :

* L'action `actions/checkout` doit rester dans le workflow principal, car elle est n√©cessaire pour acc√©der au code source.
* L'action `actions/setup-node` peut √™tre d√©plac√©e dans le workflow r√©utilisable.
* Utilisez des conditions `if` pour ex√©cuter certaines √©tapes en fonction des inputs :
  ```yaml
  - name: V√©rification du code
    if: ${{ inputs.run-lint }}
    run: npm run lint
  ```

### 3Ô∏è‚É£ Refactoriser le workflow principal

#### √âtape 1 : Utiliser le workflow r√©utilisable pour le frontend

Remplacez le job de v√©rification du frontend par un appel au workflow r√©utilisable :
```yaml
check-frontend:
  name: V√©rification du code frontend
  uses: ./.github/workflows/check-test.yml
  with:
    working-directory: ./client
    run-lint: true
    run-audit: true
    run-tests: false
    codecov-upload: false
```

#### √âtape 2 : Utiliser le workflow r√©utilisable pour le backend avec une matrice

Pour le backend, vous devez conserver la strat√©gie matrix tout en utilisant le workflow r√©utilisable :
```yaml
check-tests-backend:
  name: ${{ matrix.name }}
  strategy:
    matrix:
      include:
        - name: verify code backend
          run-lint: true
          run-audit: false
          run-tests: false
          codecov-upload: false
        # Autres configurations...
  uses: ./.github/workflows/check-test.yml
  with:
    working-directory: ./server
    run-lint: ${{ matrix.run-lint }}
    run-audit: ${{ matrix.run-audit }}
    run-tests: ${{ matrix.run-tests }}
    codecov-upload: ${{ matrix.codecov-upload }}
  secrets:
    codecov-token: ${{ secrets.CODECOV_TOKEN }}
```

## üõ†Ô∏è Conseils techniques

* Utilisez `runs-on: ubuntu-latest` pour tous les jobs
* Pensez √† ajouter des noms descriptifs √† vos jobs
* Utilisez des valeurs par d√©faut `false` pour les inputs bool√©ens pour √©viter l'ex√©cution involontaire
* N'oubliez pas de passer les secrets n√©cessaires

## ‚ö†Ô∏è Points d'attention

* Les workflows r√©utilisables ne peuvent pas √™tre d√©clench√©s directement, ils doivent √™tre appel√©s par un autre workflow
* Le `GITHUB_TOKEN` ne peut pas √™tre pass√© entre les workflows
* Les variables d'environnement ne peuvent pas √™tre pass√©es directement
* L'action `actions/checkout` doit rester dans le workflow principal

## ‚úÖ Crit√®res de r√©ussite

* Le workflow r√©utilisable est correctement configur√© avec les inputs et secrets n√©cessaires
* Le workflow principal utilise correctement le workflow r√©utilisable pour le frontend et le backend
* La strat√©gie matrix est conserv√©e pour le backend
* Les tests s'ex√©cutent correctement dans les deux contextes

## üí≠ Indices suppl√©mentaires

* Commencez par cr√©er le workflow r√©utilisable avec les inputs de base
* Testez d'abord avec le frontend, qui est plus simple
* Adaptez ensuite pour le backend en int√©grant la matrice
* N'oubliez pas d'ajouter des noms descriptifs √† vos jobs

---

Cet exercice vous permettra de comprendre comment cr√©er et utiliser des workflows r√©utilisables dans GitHub Actions, une comp√©tence essentielle pour maintenir des pipelines CI/CD efficaces et maintenables.